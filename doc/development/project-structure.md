# **Project Structure**

## **Table of Contents**

- [**Project Structure**](#project-structure)
  - [**Table of Contents**](#table-of-contents)
  - [**Abstract**](#abstract)
  - [**Submodule Structure**](#submodule-structure)
    - [**`doc`**](#doc)
    - [**`shared_modules`**](#shared_modules)
      - [**Shared Configurations**](#shared-configurations)
  - [**Workspace Structure**](#workspace-structure)
  - [**Dependency Resolution**](#dependency-resolution)
  - [](#)

## **Abstract**

The project utilizes [Git Submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules "Visit") in addition to [NPM Workspaces](https://docs.npmjs.com/cli/v9/using-npm/workspaces?v=true "Visit") to achieve a clean layout for packages.

## **Submodule Structure**

The Falkor Monorepo consists of the following Git submodules, which all are individual NPM packages:

### **`doc`**

This folder contains the collected "know-how" of the Falkor Framework development. It is a collection of pure Markdown files.

> _It is a separate submodule, that has no dependents. You can safely [de-initialize](../appendix/git-cheat-sheet.md#remove-a-submodule "Open") it, if you wish._

### **`shared_modules`**

This folder contains our shared configuration modules, and open source tools.

#### **Shared Configurations**

These are small custom NPM packages, which contain the base configuration for their respective code quality tools.

- **`prettier-config`**
  - This is our shared [Prettier](https://prettier.io/ "Visit") configuration module
- **`eslint-config`**
  - This is our shared [ESLint](https://eslint.org/ "Visit") configuration module
- **`cspell-config`**
  - This is our shared [CSpell](https://cspell.org/ "Visit") configuration module
- **`jest-config`**
  - This is our shared [Jest](https://jestjs.io/ "Visit") configuration module

> _These repositories also contain the actual tools as `dependencies` in their `package.json` (instead listed as `peerDependencies`), so version handling is centralized._

## **Workspace Structure**

The monorepo's root `package.json` tells NPM how to handle the different directories we detailed above. The snippet below in the file will tell NPM, that packages found in the directories listed are somehow interdependent, and need to be developed parallel with shared dependencies:

```jsonc
{
  "workspaces": ["shared_modules/*"]
}
```

What NPM does in this situation when running `install` is it [symlinks](https://en.wikipedia.org/wiki/Symbolic_link "Visit") the directories matching the above patterns into the root project's `node_modules` directory using their `name` from their `package.json` (regardless the directory structure they reside in), and also creates all required NPM executables in the top level `.bin` directory.

```jsonc
// ignored structure generated by NPM:

node_modules/
  .bin/

  @falkor/                             // we always use the NPM scope '@falkor' in package names
    ↳ falkor-prettier-config/                 // ↜ shared_modules/prettier-config/
    ↳ falkor-eslint-config/                   // ↜ shared_modules/eslint-config/
    ↳ falkor-cspell-config/                   // ↜ shared_modules/cspell-config/
    ↳ falkor-jest-config/                     // ↜ shared_modules/jest-config/

    ↳ falkor-jscc-webpack-plugin/             // ↜ shared_modules/jscc-webpack-plugin/

package-lock.json                      // NPM only creates lockfile in the root project

// actual project submodule directories:

shared_modules/
  prettier-config/                     // package name: "@falkor/falkor-prettier-config"
  eslint-config/                       // package name: "@falkor/falkor-eslint-config"
  cspell-config/                       // package name: "@falkor/falkor-cspell-config"
  jest-config/                         // package name: "@falkor/falkor-jest-config"

  jscc-webpack-plugin/                 // package name: "@falkor/falkor-jscc-webpack-plugin"

package.json                           // NPM configuration describing workspaces
```

- When running `install` in a workspace directory, NPM will **only** install the current workspace's dependencies.
  - In this case the NPM `workspace` configuration is implicitly set, and `prefix` is set to the top level root workspace.
- To be sure every necessary installation step is taken, use `npm install` in the **root** of the monorepo, while other `npm run` scripts from either the distinct workspace, or from root using the `--workspace <path>`, or `--workspaces --if-present` options.

> _Some of our shared modules are written in TypeScript, and have to be built before using them. This can be done manually, but is also achieved through an NPM `preinstall` script, which compiles the TypeScript sources. For this to work, one **must allow scripts** to be run upon install (aka. not use `--ignore-scripts`)._

## **Dependency Resolution**

While resolving dependencies NPM will "bring up" shared packages to the top level root project's `node_modules` directory (omitting redundancy), and will only install packages locally in the distinct workspaces, if those conflict with other versions of the same package used throughout the monorepo.

> _When using workspaces NPM only creates a lockfile in the root project containing all dependencies of the root- and all workspace packages._

When listing a workspace package as dependency, make sure that the correct version of the local workspace is used, otherwise NPM will try to find this dependency in the registry configured.

##

---

_©2020-2023 Barnabas Bucsy - All rights reserved._
